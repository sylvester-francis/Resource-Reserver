# Pre-commit configuration for Resource-Reserver
# Runs automatically before each commit to catch issues early
# Documentation: https://pre-commit.com

default_install_hook_types: [pre-commit, post-commit]
default_stages: [pre-commit]

repos:
  # Python code formatting with ruff
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.4
    hooks:
      # Run the ruff linter
      - id: ruff
        name: ruff linter (Python)
        args: [--fix]
        types_or: [python]
        
      # Run the ruff formatter
      - id: ruff-format
        name: ruff formatter (Python)
        types_or: [python]

  # Additional Python code quality checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=1000']
        
      - id: check-ast
        name: Check Python AST
        
      - id: check-builtin-literals
        name: Check builtin type constructor use
        
      - id: check-case-conflict
        name: Check for case conflicts
        
      - id: check-docstring-first
        name: Check docstring is first
        
      - id: check-executables-have-shebangs
        name: Check executables have shebangs
        
      - id: check-json
        name: Check JSON files
        
      - id: check-merge-conflict
        name: Check for merge conflicts
        
      - id: check-shebang-scripts-are-executable
        name: Check shebang scripts are executable
        
      - id: check-toml
        name: Check TOML files
        
      - id: check-yaml
        name: Check YAML files
        args: ['--unsafe']  # Allow custom tags in docker-compose.yml
        
      - id: debug-statements
        name: Check for debug statements
        
      - id: detect-private-key
        name: Detect private keys
        
      - id: end-of-file-fixer
        name: Fix end of files
        
      - id: mixed-line-ending
        name: Fix mixed line endings
        
      - id: trailing-whitespace
        name: Trim trailing whitespace
        args: [--markdown-linebreak-ext=md]
        
      - id: fix-byte-order-marker
        name: Fix byte order marker

  # Python type checking with mypy
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.13.0
    hooks:
      - id: mypy
        name: mypy (Python type checking)
        additional_dependencies:
          - types-requests
          - types-pytz
        args: [--ignore-missing-imports, --no-strict-optional]
        files: ^(app|cli)/.*\.py$
        exclude: ^tests/

  # Security scanning with bandit
  - repo: https://github.com/PyCQA/bandit
    rev: 1.8.3
    hooks:
      - id: bandit
        name: bandit (Python security)
        args: [-c, pyproject.toml]
        additional_dependencies: ["bandit[toml]"]
        files: ^(app|cli)/.*\.py$

  # Python dependency safety check
  - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
    rev: v1.3.3
    hooks:
      - id: python-safety-dependencies-check
        name: safety (Python dependencies)
        files: requirements.txt

  # Dockerfile linting
  - repo: https://github.com/hadolint/hadolint
    rev: v2.13.1-beta
    hooks:
      - id: hadolint-docker
        name: hadolint (Dockerfile linting)

  # YAML linting
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        name: yamllint (YAML files)
        args: [-c=.yamllint.yml]
        types: [yaml]

  # Shell script linting
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: shellcheck (shell scripts)

  # Markdown linting and formatting
  - repo: https://github.com/executablebooks/mdformat
    rev: 0.7.19
    hooks:
      - id: mdformat
        name: mdformat (Markdown)
        additional_dependencies:
          - mdformat-gfm
          - mdformat-black
        args: [--wrap, "no"]

  # Local custom hooks
  - repo: local
    hooks:
      # Run pytest on modified test files
      - id: pytest-check
        name: pytest (Python tests)
        entry: pytest
        language: system
        pass_filenames: false
        always_run: false
        args: [--maxfail=1, --tb=short, -q]
        files: ^tests/.*\.py$
      
      # Check for print statements in production code
      - id: no-print-statements
        name: Check for print statements
        entry: Avoid using print() in production code, use logging instead
        language: pygrep
        pattern: print\(
        files: ^(app|cli)/.*\.py$
        exclude: ^(tests|scripts)/
        
      # Ensure all Python files have proper encoding declaration
      - id: check-python-encoding
        name: Check Python file encoding
        entry: Missing coding declaration
        language: pygrep
        pattern: ^(?!.*coding[:=])
        files: \.py$
        exclude: ^(tests|venv|\.venv)/
        
      # Check that __init__.py files exist in Python packages
      - id: check-init-files
        name: Check for __init__.py files
        entry: python -c "import os, sys; [sys.exit(1) if not os.path.exists(os.path.join(root, '__init__.py')) else None for root, dirs, files in os.walk('app') if any(f.endswith('.py') for f in files)]"
        language: system
        pass_filenames: false
        files: ^app/.*\.py$

# CI mode - stricter checks when running in CI/CD
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks
    
    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: [pytest-check, python-safety-dependencies-check]
  submodules: false
