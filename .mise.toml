# mise configuration for Resource-Reserver
# Manages tool versions and environment variables for development
# Documentation: https://mise.jdx.dev
#
# All tasks are designed to be self-healing and never error out.
# They will auto-install missing dependencies and gracefully degrade.

[tools]
# Python version for backend and CLI
python = "3.11"

# Node.js for frontend (fallback if bun fails)
node = "20"

# Bun - Fast JavaScript runtime
bun = "latest"

# Tilt for development workflow (optional)
tilt = "latest"

# uv - Fast Python package installer (optional)
"pipx:uv" = "latest"

[env]
# Development environment variables
DATABASE_URL = "sqlite:///./data/resource_reserver_dev.db"
ENVIRONMENT = "development"
SECRET_KEY = "dev-secret-key-change-in-production"
API_BASE_URL = "http://localhost:8000"
NODE_ENV = "development"

# Python development settings
PYTHONDONTWRITEBYTECODE = "1"
PYTHONUNBUFFERED = "1"

# CLI configuration
CLI_CONFIG_DIR = "{{config_root}}/.resource-reserver-cli"

# Bun settings
BUN_INSTALL = "{{env.HOME}}/.bun"

# =============================================================================
# HELPER TASK: Ensures environment is ready (called by other tasks)
# =============================================================================
[tasks._ensure-env]
description = "Internal: Ensure environment is ready"
hide = true
run = """
#!/usr/bin/env bash

# Create data directory if missing
mkdir -p data 2>/dev/null || true

# Ensure Python venv exists and is activated
if [ ! -d "venv" ]; then
    echo "ðŸ“¦ Creating Python virtual environment..."
    python -m venv venv
fi

# Auto-activate venv for this script
source venv/bin/activate 2>/dev/null || true

# Check if pip packages are installed, if not install them
if ! python -c "import fastapi" 2>/dev/null; then
    echo "ðŸ“¦ Installing Python dependencies..."
    if command -v uv > /dev/null 2>&1; then
        uv pip install -r requirements.txt -q
    else
        pip install -r requirements.txt -q
    fi
fi

# Check frontend deps
if [ ! -d "frontend-next/node_modules" ]; then
    echo "ðŸ“¦ Installing frontend dependencies..."
    cd frontend-next
    if command -v bun > /dev/null 2>&1; then
        bun install --silent
    elif command -v npm > /dev/null 2>&1; then
        npm install --silent
    fi
    cd ..
fi
"""

# =============================================================================
# SETUP TASKS
# =============================================================================
[tasks.setup]
description = "Install all project dependencies (self-healing)"
run = """
#!/usr/bin/env bash
set -e

echo "ðŸš€ Setting up Resource-Reserver..."
echo ""

# Create directories
mkdir -p data 2>/dev/null || true

# Setup Python environment
echo "ðŸ“¦ Setting up Python environment..."
if [ ! -d "venv" ]; then
    python -m venv venv
    echo "   âœ“ Created virtual environment"
else
    echo "   âœ“ Virtual environment exists"
fi

source venv/bin/activate

# Install Python dependencies
echo "ðŸ“¦ Installing Python dependencies..."
if command -v uv > /dev/null 2>&1; then
    uv pip install -r requirements.txt -q && echo "   âœ“ Python dependencies installed (via uv)"
else
    pip install -r requirements.txt -q && echo "   âœ“ Python dependencies installed (via pip)"
fi

# Install pre-commit hooks
if command -v pre-commit > /dev/null 2>&1; then
    pre-commit install -q 2>/dev/null && echo "   âœ“ Git hooks installed" || true
fi

# Install frontend dependencies
echo "ðŸ“¦ Installing frontend dependencies..."
cd frontend-next
if command -v bun > /dev/null 2>&1; then
    bun install --silent && echo "   âœ“ Frontend dependencies installed (via bun)"
elif command -v npm > /dev/null 2>&1; then
    npm install --silent && echo "   âœ“ Frontend dependencies installed (via npm)"
else
    echo "   âš  No package manager found (install bun or npm)"
fi
cd ..

echo ""
echo "âœ… Setup complete!"
echo ""
echo "Quick start commands:"
echo "  mise run up        - Start all services"
echo "  mise run dev       - Start dev servers"
echo "  mise run test      - Run tests"
echo "  mise run help      - Show all commands"
"""

[tasks.setup-hooks]
description = "Install git hooks (auto-heals)"
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

# Install pre-commit if missing
if ! command -v pre-commit > /dev/null 2>&1; then
    echo "Installing pre-commit..."
    pip install pre-commit -q
fi

pre-commit install
pre-commit install --hook-type post-commit
echo "âœ… Git hooks installed"
"""

# =============================================================================
# SERVICE MANAGEMENT
# =============================================================================
[tasks.up]
description = "Start all services (Docker + optional Tilt UI)"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash

echo "ðŸš€ Starting Resource-Reserver..."
echo ""

# Check Docker
if ! command -v docker > /dev/null 2>&1; then
    echo "âŒ Docker not found. Please install Docker Desktop."
    echo "   https://www.docker.com/products/docker-desktop"
    exit 1
fi

if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker Desktop."
    exit 1
fi

# Start services
docker compose up -d --build 2>&1 | grep -v "^$" || true

echo ""
echo "âœ… Services started:"
echo "   Backend API:  http://localhost:8000"
echo "   Frontend:     http://localhost:3000"
echo "   API Docs:     http://localhost:8000/docs"

# Optional Tilt
if command -v tilt > /dev/null 2>&1; then
    echo ""
    echo "Starting Tilt UI for monitoring..."
    tilt up --stream=false --legacy > /tmp/tilt.log 2>&1 &
    echo "   Tilt UI:      http://localhost:10350"
fi

echo ""
echo "Commands:"
echo "   mise run logs   - View logs"
echo "   mise run down   - Stop services"
"""

[tasks.down]
description = "Stop all services gracefully"
run = """
#!/usr/bin/env bash
echo "ðŸ›‘ Stopping services..."

# Stop Tilt if running
pkill -f "tilt up" 2>/dev/null || true
tilt down 2>/dev/null || true

# Stop Docker
docker compose down 2>/dev/null || true

echo "âœ… All services stopped"
"""

[tasks.restart]
description = "Restart all services"
run = """
#!/usr/bin/env bash
mise run down
sleep 2
mise run up
"""

[tasks.logs]
description = "View service logs (follow mode)"
run = """
#!/usr/bin/env bash
if docker compose ps -q 2>/dev/null | grep -q .; then
    docker compose logs -f --tail=100
else
    echo "No services running. Start with: mise run up"
fi
"""

# =============================================================================
# DEVELOPMENT
# =============================================================================
[tasks.dev]
description = "Start development servers (backend + frontend)"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

echo "ðŸš€ Starting development servers..."
echo ""

# Start backend in background
echo "Starting backend on http://localhost:8000..."
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &
BACKEND_PID=$!

# Give backend time to start
sleep 2

# Start frontend
echo "Starting frontend on http://localhost:3000..."
cd frontend-next
if command -v bun > /dev/null 2>&1; then
    bun run dev &
else
    npm run dev &
fi
FRONTEND_PID=$!
cd ..

echo ""
echo "âœ… Development servers running:"
echo "   Backend:  http://localhost:8000 (PID: $BACKEND_PID)"
echo "   Frontend: http://localhost:3000 (PID: $FRONTEND_PID)"
echo "   API Docs: http://localhost:8000/docs"
echo ""
echo "Press Ctrl+C to stop all servers"

# Wait and cleanup on exit
trap "kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; echo ''; echo 'Servers stopped'" EXIT
wait
"""

[tasks.backend-dev]
description = "Start backend development server only"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
echo "ðŸš€ Starting backend on http://localhost:8000..."
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
"""

[tasks.frontend-dev]
description = "Start frontend development server only"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
cd frontend-next
echo "ðŸš€ Starting frontend on http://localhost:3000..."
if command -v bun > /dev/null 2>&1; then
    bun run dev
else
    npm run dev
fi
"""

[tasks.docs]
description = "Start documentation server"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

# Install mkdocs if missing
if ! python -c "import mkdocs" 2>/dev/null; then
    echo "Installing MkDocs..."
    pip install mkdocs mkdocs-material -q
fi

echo "ðŸ“š Starting documentation server on http://localhost:8080..."
mkdocs serve -a localhost:8080
"""

# =============================================================================
# TESTING
# =============================================================================
[tasks.test]
description = "Run all tests"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
echo "ðŸ§ª Running all tests..."
pytest tests/ -v --tb=short
"""

[tasks.test-fast]
description = "Run tests without slow tests"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
echo "ðŸ§ª Running fast tests..."
pytest tests/ -v --tb=short -m "not slow" 2>/dev/null || pytest tests/ -v --tb=short
"""

[tasks.test-backend]
description = "Run backend API tests only"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
echo "ðŸ§ª Running backend tests..."
pytest tests/test_api/ tests/test_services/ -v --tb=short
"""

[tasks.test-cli]
description = "Run CLI tests only"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
echo "ðŸ§ª Running CLI tests..."
pytest tests/test_cli/ -v --tb=short
"""

[tasks.test-e2e]
description = "Run E2E tests with Playwright"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
cd frontend-next

# Install Playwright if needed
if [ ! -d "node_modules/@playwright" ]; then
    echo "Installing Playwright..."
    if command -v bun > /dev/null 2>&1; then
        bun add -D @playwright/test
    else
        npm install -D @playwright/test
    fi
    npx playwright install chromium
fi

echo "ðŸ§ª Running E2E tests..."
if command -v bun > /dev/null 2>&1; then
    bun run test:e2e
else
    npm run test:e2e
fi
"""

[tasks.test-cov]
description = "Run tests with coverage report"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
echo "ðŸ§ª Running tests with coverage..."
pytest tests/ --cov=app --cov-report=term-missing --cov-report=html
echo ""
echo "Coverage report: htmlcov/index.html"
"""

# =============================================================================
# CODE QUALITY
# =============================================================================
[tasks.lint]
description = "Run all linters (auto-fixes where possible)"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true
EXIT_CODE=0

echo "ðŸ” Linting Python..."
if command -v ruff > /dev/null 2>&1; then
    ruff check . --fix || EXIT_CODE=1
else
    echo "   âš  ruff not found, installing..."
    pip install ruff -q
    ruff check . --fix || EXIT_CODE=1
fi

echo ""
echo "ðŸ” Linting frontend..."
cd frontend-next
if command -v bun > /dev/null 2>&1; then
    bun run lint 2>/dev/null || npm run lint 2>/dev/null || echo "   âš  Frontend lint skipped"
else
    npm run lint 2>/dev/null || echo "   âš  Frontend lint skipped"
fi
cd ..

if [ $EXIT_CODE -eq 0 ]; then
    echo ""
    echo "âœ… Linting complete - no issues!"
else
    echo ""
    echo "âš  Some lint issues found (auto-fixed where possible)"
fi
exit 0  # Always succeed to not block workflow
"""

[tasks.format]
description = "Format all code"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

echo "âœ¨ Formatting Python..."
if command -v ruff > /dev/null 2>&1; then
    ruff format .
    ruff check --fix . 2>/dev/null || true
else
    pip install ruff -q
    ruff format .
fi

echo ""
echo "âœ… Formatting complete!"
"""

[tasks.typecheck]
description = "Run type checking"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

echo "ðŸ” Type checking Python..."
if command -v mypy > /dev/null 2>&1; then
    mypy app/ --ignore-missing-imports || true
else
    echo "   âš  mypy not installed, skipping (pip install mypy)"
fi

echo ""
echo "ðŸ” Type checking frontend..."
cd frontend-next
if command -v bun > /dev/null 2>&1; then
    bun run build 2>&1 | head -20 || true
else
    npm run build 2>&1 | head -20 || true
fi
cd ..
"""

# =============================================================================
# BUILD & DEPLOY
# =============================================================================
[tasks.build]
description = "Build all projects for production"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

echo "ðŸ”¨ Building frontend..."
cd frontend-next
if command -v bun > /dev/null 2>&1; then
    bun run build
else
    npm run build
fi
cd ..

echo ""
echo "ðŸ”¨ Building documentation..."
if python -c "import mkdocs" 2>/dev/null; then
    mkdocs build -q
    echo "   âœ“ Docs built to site/"
else
    echo "   âš  mkdocs not installed, skipping docs"
fi

echo ""
echo "âœ… Build complete!"
"""

[tasks.build-docker]
description = "Build Docker images"
run = """
#!/usr/bin/env bash
echo "ðŸ³ Building Docker images..."
docker compose build
echo "âœ… Docker images built!"
"""

# =============================================================================
# DATABASE
# =============================================================================
[tasks.db-migrate]
description = "Run database migrations"
depends = ["_ensure-env"]
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

if [ -d "migrations" ]; then
    echo "ðŸ—„ï¸ Running migrations..."
    alembic upgrade head
    echo "âœ… Migrations complete!"
else
    echo "No migrations directory found. Using auto-create tables."
    python -c "from app.database import engine, Base; Base.metadata.create_all(bind=engine)"
    echo "âœ… Database tables created!"
fi
"""

[tasks.db-reset]
description = "Reset database (WARNING: deletes all data)"
run = """
#!/usr/bin/env bash
source venv/bin/activate 2>/dev/null || true

echo "âš ï¸  This will delete all data. Press Ctrl+C to cancel..."
sleep 3

rm -f data/*.db 2>/dev/null || true
echo "ðŸ—„ï¸ Creating fresh database..."
python -c "from app.database import engine, Base; Base.metadata.create_all(bind=engine)"
echo "âœ… Database reset complete!"
"""

# =============================================================================
# UTILITIES
# =============================================================================
[tasks.clean]
description = "Clean all caches and temporary files"
run = """
#!/usr/bin/env bash
echo "ðŸ§¹ Cleaning caches..."

# Python caches
rm -rf __pycache__ .pytest_cache .ruff_cache .mypy_cache .tox htmlcov .coverage 2>/dev/null || true
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true

# Frontend caches
rm -rf frontend-next/.next frontend-next/node_modules/.cache 2>/dev/null || true
rm -rf frontend-next/playwright-report frontend-next/test-results 2>/dev/null || true

# Build artifacts
rm -rf site .tiltbuild 2>/dev/null || true

echo "âœ… Clean complete!"
"""

[tasks.clean-all]
description = "Clean everything including node_modules and venv"
run = """
#!/usr/bin/env bash
echo "ðŸ§¹ Deep cleaning..."

mise run clean

rm -rf venv 2>/dev/null || true
rm -rf frontend-next/node_modules 2>/dev/null || true

echo "âœ… Deep clean complete! Run 'mise run setup' to reinstall."
"""

[tasks.status]
description = "Show status of all services and tools"
run = """
#!/usr/bin/env bash
echo "ðŸ“Š Resource-Reserver Status"
echo "=========================="
echo ""

# Python
echo "Python:"
if [ -d "venv" ]; then
    echo "   âœ“ Virtual environment exists"
    source venv/bin/activate 2>/dev/null
    if python -c "import fastapi" 2>/dev/null; then
        echo "   âœ“ Dependencies installed"
    else
        echo "   âœ— Dependencies missing (run: mise run setup)"
    fi
else
    echo "   âœ— No virtual environment (run: mise run setup)"
fi

# Frontend
echo ""
echo "Frontend:"
if [ -d "frontend-next/node_modules" ]; then
    echo "   âœ“ Dependencies installed"
else
    echo "   âœ— Dependencies missing (run: mise run setup)"
fi

# Docker
echo ""
echo "Docker:"
if command -v docker > /dev/null 2>&1; then
    if docker info > /dev/null 2>&1; then
        echo "   âœ“ Docker running"
        CONTAINERS=$(docker compose ps -q 2>/dev/null | wc -l | tr -d ' ')
        if [ "$CONTAINERS" -gt "0" ]; then
            echo "   âœ“ $CONTAINERS container(s) running"
        else
            echo "   - No containers running"
        fi
    else
        echo "   âš  Docker installed but not running"
    fi
else
    echo "   âœ— Docker not installed"
fi

# Tools
echo ""
echo "Tools:"
command -v bun > /dev/null 2>&1 && echo "   âœ“ bun $(bun --version 2>/dev/null)" || echo "   - bun not installed"
command -v node > /dev/null 2>&1 && echo "   âœ“ node $(node --version 2>/dev/null)" || echo "   - node not installed"
command -v tilt > /dev/null 2>&1 && echo "   âœ“ tilt installed" || echo "   - tilt not installed (optional)"
command -v uv > /dev/null 2>&1 && echo "   âœ“ uv installed (fast pip)" || echo "   - uv not installed (optional)"
"""

[tasks.help]
description = "Show all available commands"
run = """
#!/usr/bin/env bash
echo "ðŸ“š Resource-Reserver Commands"
echo "============================="
echo ""
echo "Setup & Install:"
echo "  mise run setup        - Install all dependencies"
echo "  mise run setup-hooks  - Install git hooks"
echo ""
echo "Services:"
echo "  mise run up           - Start all services (Docker)"
echo "  mise run down         - Stop all services"
echo "  mise run restart      - Restart services"
echo "  mise run logs         - View service logs"
echo ""
echo "Development:"
echo "  mise run dev          - Start backend + frontend"
echo "  mise run backend-dev  - Start backend only"
echo "  mise run frontend-dev - Start frontend only"
echo "  mise run docs         - Start documentation server"
echo ""
echo "Testing:"
echo "  mise run test         - Run all tests"
echo "  mise run test-fast    - Run fast tests only"
echo "  mise run test-backend - Run backend tests"
echo "  mise run test-cli     - Run CLI tests"
echo "  mise run test-e2e     - Run E2E tests"
echo "  mise run test-cov     - Run tests with coverage"
echo ""
echo "Code Quality:"
echo "  mise run lint         - Run linters (auto-fix)"
echo "  mise run format       - Format all code"
echo "  mise run typecheck    - Run type checking"
echo ""
echo "Build:"
echo "  mise run build        - Build for production"
echo "  mise run build-docker - Build Docker images"
echo ""
echo "Database:"
echo "  mise run db-migrate   - Run migrations"
echo "  mise run db-reset     - Reset database"
echo ""
echo "Utilities:"
echo "  mise run clean        - Clean caches"
echo "  mise run clean-all    - Clean everything"
echo "  mise run status       - Show status"
echo "  mise run help         - Show this help"
"""
