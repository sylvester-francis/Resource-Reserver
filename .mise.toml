# mise configuration for Resource-Reserver
# Manages tool versions and environment variables for development
# Documentation: https://mise.jdx.dev

[tools]
# Python version for backend and CLI
python = "3.11"

# Bun - Fast JavaScript runtime (replaces Node.js/npm)
bun = "latest"

# Moon - Build orchestration for monorepo
"ubi:moonrepo/moon" = "latest"

# Tilt for development workflow (optional)
tilt = "latest"

# uv - Fast Python package installer (optional, for faster pip)
"pipx:uv" = "latest"

[env]
# Development environment variables
DATABASE_URL = "sqlite:///./data/resource_reserver_dev.db"
ENVIRONMENT = "development"
SECRET_KEY = "dev-secret-key-change-in-production"
API_BASE_URL = "http://localhost:8000"
NODE_ENV = "development"

# Python development settings
PYTHONDONTWRITEBYTECODE = "1"
PYTHONUNBUFFERED = "1"

# CLI configuration
CLI_CONFIG_DIR = "{{config_root}}/.resource-reserver-cli"

# Bun settings
BUN_INSTALL = "{{env.HOME}}/.bun"

[tasks.setup]
description = "Install all project dependencies"
run = """
#!/usr/bin/env bash
set -e
echo "ðŸ“¦ Installing Python dependencies..."
if command -v uv > /dev/null 2>&1; then
    uv pip install -r requirements.txt
else
    pip install -r requirements.txt
fi

echo "ðŸ“¦ Installing frontend dependencies with Bun..."
cd frontend-next && bun install

echo "âœ… Setup complete!"
"""

[tasks.dev]
description = "Start development environment with Tilt"
run = "tilt up"

[tasks.down]
description = "Stop Tilt development environment"
run = "tilt down"

[tasks.build]
description = "Build all projects"
run = """
#!/usr/bin/env bash
echo "ðŸ”¨ Building frontend..."
cd frontend-next && bun run build
echo "âœ… Build complete!"
"""

[tasks.test]
description = "Run all tests"
run = "pytest tests/"

[tasks.test-backend]
description = "Run backend tests only"
run = "pytest tests/test_api/ tests/test_services/"

[tasks.test-cli]
description = "Run CLI tests only"
run = "pytest tests/test_cli/"

[tasks.lint]
description = "Run all linters"
run = """
#!/usr/bin/env bash
echo "ðŸ” Linting Python..."
ruff check .
black --check .
echo "ðŸ” Linting frontend..."
cd frontend-next && bun run lint
echo "âœ… Linting complete!"
"""

[tasks.format]
description = "Format all code"
run = """
#!/usr/bin/env bash
echo "âœ¨ Formatting Python..."
black .
ruff check --fix .
echo "âœ… Formatting complete!"
"""

[tasks.setup-hooks]
description = "Install git hooks"
run = """
#!/usr/bin/env bash
pip install pre-commit
pre-commit install
pre-commit install --hook-type post-commit
"""

[tasks.docker]
description = "Start services with Docker Compose (alternative to Tilt)"
run = "docker compose up -d"

[tasks.docker-down]
description = "Stop Docker Compose services"
run = "docker compose down"

[tasks.clean]
description = "Clean caches and temporary files"
run = """
#!/usr/bin/env bash
echo "ðŸ§¹ Cleaning caches..."
rm -rf __pycache__ .pytest_cache .ruff_cache .mypy_cache .tox
rm -rf frontend-next/.next frontend-next/node_modules/.cache
rm -rf .tiltbuild
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
echo "âœ… Clean complete!"
"""

[tasks.frontend-dev]
description = "Start frontend development server"
run = "cd frontend-next && bun run dev"

[tasks.backend-dev]
description = "Start backend development server"
run = "uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"
