# mise configuration for Resource-Reserver
# Manages tool versions and environment variables for development
# Documentation: https://mise.jdx.dev

[tools]
# Python version for backend and CLI
python = "3.11"

# Bun - Fast JavaScript runtime (replaces Node.js/npm)
bun = "latest"

# Moon - Build orchestration for monorepo
"ubi:moonrepo/moon" = "latest"

# Tilt for development workflow (optional)
tilt = "latest"

# uv - Fast Python package installer (optional, for faster pip)
"pipx:uv" = "latest"

[env]
# Development environment variables
DATABASE_URL = "sqlite:///./data/resource_reserver_dev.db"
ENVIRONMENT = "development"
SECRET_KEY = "dev-secret-key-change-in-production"
API_BASE_URL = "http://localhost:8000"
NODE_ENV = "development"

# Python development settings
PYTHONDONTWRITEBYTECODE = "1"
PYTHONUNBUFFERED = "1"

# CLI configuration
CLI_CONFIG_DIR = "{{config_root}}/.resource-reserver-cli"

# Bun settings
BUN_INSTALL = "{{env.HOME}}/.bun"

[tasks.setup]
description = "Install all project dependencies"
run = """
#!/usr/bin/env bash
set -e
echo "ðŸ“¦ Installing Python dependencies..."
if command -v uv > /dev/null 2>&1; then
    uv pip install -r requirements.txt
else
    pip install -r requirements.txt
fi

echo "ðŸ“¦ Installing frontend dependencies with Bun..."
cd frontend-next && bun install

echo "âœ… Setup complete!"
"""

[tasks.up]
description = "Start all services via Tilt (shows live status/logs)"
run = """
#!/usr/bin/env bash
set -e
echo "Starting Resource-Reserver with Docker Compose..."
docker compose up -d --build

echo ""
echo "Services started:"
echo "  Backend API:  http://localhost:8000"
echo "  Frontend:     http://localhost:3000"
echo "  API Docs:     http://localhost:8000/docs"

# Optionally launch Tilt after services are up for UI/logs
if command -v tilt >/dev/null 2>&1; then
  echo ""
  echo "Starting Tilt for monitoring (logs: /tmp/tilt.log)..."
  tilt up --stream=false --legacy > /tmp/tilt.log 2>&1 &
  TILT_PID=$!
  echo "  Tilt UI:      http://localhost:10350  (PID $TILT_PID)"
else
  echo ""
  echo "Tilt not installed; skipping Tilt UI. Run 'mise install tilt' if you want it."
fi

echo ""
echo "Run 'mise run down' to stop services (will also stop Tilt if running)"
echo "Run 'mise run logs' to view logs"
"""

[tasks.down]
description = "Stop all services"
run = """
#!/usr/bin/env bash
echo "Stopping services..."
tilt down 2>/dev/null || true
docker compose down 2>/dev/null || true
echo "All services stopped."
"""

[tasks.dev]
description = "Start development environment with Tilt UI"
run = "tilt up"

[tasks.build]
description = "Build all projects"
run = """
#!/usr/bin/env bash
echo "ðŸ”¨ Building frontend..."
cd frontend-next && bun run build
echo "âœ… Build complete!"
"""

[tasks.test]
description = "Run all tests"
run = "pytest tests/"

[tasks.test-backend]
description = "Run backend tests only"
run = "pytest tests/test_api/ tests/test_services/"

[tasks.test-cli]
description = "Run CLI tests only"
run = "pytest tests/test_cli/"

[tasks.lint]
description = "Run all linters"
run = """
#!/usr/bin/env bash
echo "Linting Python..."
ruff check .
ruff format --check .
echo "Linting frontend..."
cd frontend-next && bun run lint
echo "Linting complete!"
"""

[tasks.format]
description = "Format all code"
run = """
#!/usr/bin/env bash
echo "Formatting Python..."
ruff format .
ruff check --fix .
echo "Formatting complete!"
"""

[tasks.logs]
description = "View service logs"
run = "docker compose logs -f"

[tasks.setup-hooks]
description = "Install git hooks"
run = """
#!/usr/bin/env bash
pip install pre-commit
pre-commit install
pre-commit install --hook-type post-commit
"""

[tasks.docker]
description = "Start services with Docker Compose (alternative to Tilt)"
run = "docker compose up -d"

[tasks.docker-down]
description = "Stop Docker Compose services"
run = "docker compose down"

[tasks.clean]
description = "Clean caches and temporary files"
run = """
#!/usr/bin/env bash
echo "ðŸ§¹ Cleaning caches..."
rm -rf __pycache__ .pytest_cache .ruff_cache .mypy_cache .tox
rm -rf frontend-next/.next frontend-next/node_modules/.cache
rm -rf .tiltbuild
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
echo "âœ… Clean complete!"
"""

[tasks.frontend-dev]
description = "Start frontend development server"
run = "cd frontend-next && bun run dev"

[tasks.backend-dev]
description = "Start backend development server"
run = "uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"
